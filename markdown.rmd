---
title: "Raport z danych pacjentów"
author: "Dawid Genert, Agnieszka Ancypo, Sylwia Bech"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: flatly
    highlight: tango
    toc: true
    toc_float: true
---


```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(validate)
library(tidyselect)
library(ggplot2)
library(naniar)
library(tidyr)
dane <- read.csv("cancer patient data sets.csv")

```

```{r inject_missing, echo = TRUE}
# Funkcja do wstawiania losowych braków (NA) do zadanych zmiennych
inject_missing <- function(df, vars, prop = 0.1, seed = NULL) {
  if (!is.null(seed)) set.seed(seed)
  n <- nrow(df)
  for (v in vars) {
    if (!v %in% names(df)) {
      warning(sprintf("Zmienna %s nie istnieje w danych - pomijam", v))
      next
    }
    k <- floor(prop * n)
    if (k <= 0) next
    idx <- sample(seq_len(n), size = k)
    df[idx, v] <- NA
  }
  df
}

# Domyślne wstawienie braków do 3 zmiennych (możesz zmienić nazwy/proporcję)
dane <- inject_missing(dane,
                       vars = c("Age", "Smoking", "Alcohol.use"),
                       prop = 0.1,
                       seed = 123)

# Pokazanie podstawowego podsumowania liczby NA w zmiennych
sapply(dane[c("Age", "Smoking", "Alcohol.use")], function(x) sum(is.na(x)))
```

```{r, include = FALSE}
miss_var_summary(dane)
miss_case_summary(dane)
vis_miss(dane)
gg_miss_var(dane) +
  labs(title = "Liczba braków danych w każdej zmiennej")
gg_miss_case(dane) +
  labs(title = "Braki danych w poszczególnych wierszach")
gg_miss_upset(dane)
miss_var_summary(dane)
```

# WSTĘP 
Rak płuc jest jedną z najczęstszych i najbardziej śmiertelnych chorób nowotworowych na świecie. Według danych Światowej Organizacji Zdrowia (WHO) stanowi on jedną z głównych przyczyn zgonów z powodu nowotworów, a jego rozwój często wiąże się z długotrwałym narażeniem na czynniki środowiskowe i styl życia, takie jak palenie papierosów, zanieczyszczenie powietrza, spożycie alkoholu czy kontakt z substancjami toksycznymi w miejscu pracy.

Celem niniejszej analizy jest zbadanie czynników, które mogą mieć wpływ na ryzyko zachorowania na raka płuc oraz identyfikacja potencjalnych zależności między nimi. Wykorzystany zbiór danych pochodzi z platformy Kaggle
 i zawiera informacje dotyczące pacjentów, obejmujące:
- wiek, płeć,
- ekspozycję na zanieczyszczenia powietrza, alkohol, palenie papierosów,
- czynniki genetyczne, choroby przewlekłe, dietę, otyłość,
- objawy takie jak kaszel z krwią, duszność, utrata masy ciała itp.

Analiza ma na celu zbadanie zależności między wymienionymi czynnikami a występowaniem raka płuc, a także wskazanie zmiennych, które mogą w największym stopniu wpływać na ryzyko zachorowania. W ramach pracy postawiono następujące pytania badawcze:
1. Jakie czynniki najczęściej współwystępują z występowaniem raka płuc?  
2. Czy istnieją różnice między płciami w częstości zachorowań?  
3. Czy czynniki środowiskowe (zanieczyszczenie, palenie, alkohol) mają istotny wpływ?  


```{r, include = FALSE}
dane <- dane %>%
  filter(
    Age >= 0 & Age <= 110,
    Gender %in% c(1,2),
    Air.Pollution %in% c(1:8),
    Alcohol.use %in% c(1:8),
    chronic.Lung.Disease %in% c(1:7),
    Genetic.Risk %in% c(1:7),
    Smoking %in% c(1:8),
    Dust.Allergy %in% c(1:8),
    Chest.Pain %in% c(1:9),
    Coughing.of.Blood %in% c(1:9),
    Fatigue %in% c(1:9),
    Weight.Loss %in% c(1:8),
    Shortness.of.Breath %in% c(1:9),
    Swallowing.Difficulty %in% c(1:8),
    OccuPational.Hazards %in% c(1:8),
    Balanced.Diet %in% c(1:7),
    Obesity %in% c(1:7),
    Passive.Smoker %in% c(1:8),
    Wheezing %in% c(1:8),
    Clubbing.of.Finger.Nails %in% c(1:9),
    Frequent.Cold %in% c(1:7),
    Dry.Cough %in% c(1:7),
    Snoring %in% c(1:7)
  )
```
```{r, include = FALSE}
    dane <- dane %>%
      mutate(obese_and_balanced = (Balanced.Diet %in% 7 & Obesity %in% 7))


    table(dane$obese_and_balanced, useNA = "ifany")

    dane <- dane %>%
      mutate(teen_alcohol_user = (Alcohol.use %in% 1:8 & Age %in% 1:18))


    table(dane$teen_alcohol_user, useNA = "ifany")

    dane <- dane %>%
      mutate(teen_smoker = (Smoking %in% 1:8 & Age %in% 1:18))


    table(dane$teen_smoker, useNA = "ifany")

    dane <- dane %>%
      mutate(lung_no_breathing = (chronic.Lung.Disease %in% 6:7 & Shortness.of.Breath %in% 1))

    table(dane$lung_no_breathing, useNA = "ifany")

    dane <- dane %>%
      mutate(blood_no_symptoms = (Coughing.of.Blood %in% 8:9 & Chest.Pain %in% 1 & Shortness.of.Breath %in% 1))

    table(dane$blood_no_symptoms, useNA = "ifany")

    dane <- dane %>%
      mutate(heavy_smoker_no_symptoms = (Smoking %in% 7:8 &
                                     Wheezing %in% 1 &
                                     Dry.Cough %in% 1 &
                                     Shortness.of.Breath %in% 1))

    table(dane$heavy_smoker_no_symptoms, useNA = "ifany")

    dane <- dane %>%
      mutate(alcohol_healthy_and_fit = (Alcohol.use %in% 7:8 &
                                   Balanced.Diet %in% 7 &
                                   Obesity %in% 1:2))

    table(dane$alcohol_healthy_and_fit, useNA = "ifany")

    dane <- dane %>%
      mutate(high_genetic_no_context = (
        Genetic.Risk %in% 7 &
        Smoking %in% 1 &
        Alcohol.use %in% 1 &
        Air.Pollution %in% 1 &
        chronic.Lung.Disease %in% 1 &
        Shortness.of.Breath %in% 1 &
        Chest.Pain %in% 1
        ))
    table(dane$snoring_no_risk_factors, useNA = "ifany")

        dane <- dane %>%
      mutate(fatigue_no_other_symptoms = (
       Fatigue %in% 9 &
        Weight.Loss %in% 1 &
        Shortness.of.Breath %in% 1 &
        Chest.Pain %in% 1 &
        Frequent.Cold %in% 1
        ))
    table(dane$fatigue_no_other_symptoms, useNA = "ifany")

        dane <- dane %>%
      mutate(snoring_no_risk_factors = (
        Snoring %in% 6:7 &
        Obesity %in% 1:2 &
       Shortness.of.Breath %in% 1
      ))
    table(dane$high_genetic_no_context, useNA = "ifany")

    dane <- dane %>%
  mutate(
    suspicious_score = rowSums(
      select(., obese_and_balanced,
                teen_alcohol_user,
                teen_smoker,
                lung_no_breathing,
                blood_no_symptoms,
                heavy_smoker_no_symptoms,
                alcohol_healthy_and_fit,
                high_genetic_no_context,
                fatigue_no_other_symptoms,
                snoring_no_risk_factors),
      na.rm = TRUE
    )
  )
  table(dane$suspicious_score)

  dane %>% 
  arrange(desc(suspicious_score)) %>% 
  head(10)

  summary_suspicious <- dane %>%
  mutate(
    suspicious_level = case_when(
      suspicious_score == 1 ~ "slightly suspicious",
      suspicious_score == 2 ~ "moderately suspicious",
      suspicious_score >= 3 ~ "highly suspicious",
      TRUE ~ "not suspicious"
    )
  ) %>%
  count(suspicious_level) %>%
  mutate(
    procent = round(100 * n / sum(n), 2)
  )

summary_suspicious
```
```{r, include = FALSE}

dane %>%
  ggplot(aes(x = suspicious_score)) +
  geom_bar() +
  labs(
    title = "Number of suspicious rules per record",
    x = "suspicious_score (number of triggered flags)",
    y = "Record count"
  )

  dane %>%
  ggplot(aes(x = suspicious_score, y = Age, group = suspicious_score)) +
  geom_boxplot() +
  labs(
    title = "Age vs number of suspicious rules",
    x = "suspicious_score",
    y = "Age"
  )
flags_long <- dane %>%
  filter(suspicious_score >= 1) %>%
  select(obese_and_balanced,
         teen_alcohol_user,
         teen_smoker,
         lung_no_breathing,
         blood_no_symptoms,
         heavy_smoker_no_symptoms,
         alcohol_healthy_and_fit,
         high_genetic_no_context,
         fatigue_no_other_symptoms,
         snoring_no_risk_factors) %>%
  mutate(row_id = row_number()) %>%
  pivot_longer(
    cols = -row_id,
    names_to = "flag",
    values_to = "value"
  ) %>%
  filter(value == TRUE)
  flags_long %>%
  count(flag) %>%
  ggplot(aes(x = reorder(flag, n), y = n)) +
  geom_col() +
  coord_flip() +
  labs(
    title = "Frequency of triggered flags among suspicious records",
    x = "Flag",
    y = "Count"
  )

```